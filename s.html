<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>STERLA - Integrated Mindmap + ChatGPT</title>
<style>
:root{
  --black:#0b0b0d; --card:#111216; --light-blue:#84d2ff; --light-purple:#c2b3ff;
  --muted:#9aa0b4; --white:#ffffff; --success:#3cd48b; --danger:#e55a5a;
}
*{box-sizing:border-box;font-family:Inter,Poppins,sans-serif;}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#0b0b0d 0%,#0f1724 100%);color:var(--white);}
#loginPage{height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
.login-card{background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.02));padding:28px;border-radius:20px;width:360px;box-shadow:0 12px 40px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03);}
.login-card h2{margin-bottom:8px;color:var(--light-purple)}
.login-card p{color:var(--muted);margin-bottom:16px}
.input{width:100%;padding:12px;border-radius:12px;border:none;margin:8px 0;background:rgba(255,255,255,0.03);color:var(--white);outline:none}
.btn{width:100%;padding:12px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--light-blue),var(--light-purple));color:#001;cursor:pointer;font-weight:700}
.small-btn{padding:8px 12px;border-radius:10px;border:none;background:transparent;color:var(--light-blue);cursor:pointer}
#appPage{display:none;height:100vh;display:flex;overflow:hidden}
#sidebar{width:260px;background:linear-gradient(180deg,#071028,#0b1633);padding:28px;color:var(--white);border-right:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:14px}
.brand{font-size:28px;font-weight:800;color:var(--light-purple);letter-spacing:1px}
.nav-btn{background:transparent;border:none;color:var(--muted);padding:12px 14px;text-align:left;border-radius:10px;cursor:pointer;font-weight:700}
.nav-btn.active, .nav-btn:hover{background:rgba(255,255,255,0.02);color:var(--white);box-shadow:0 6px 20px rgba(124,107,255,0.08)}
#main{flex:1;overflow:auto;padding:30px;background:linear-gradient(180deg,#0b0f1a 0%,#0b1220 30%)}
#welcomeBox{background:linear-gradient(180deg,#071028,#0b1430);border-radius:16px;padding:26px;color:var(--white);display:flex;justify-content:space-between;align-items:center;gap:20px}
#welcomeBox h2{color:var(--light-blue);font-size:22px;margin:0}
#welcomeBox p{margin:0;color:var(--muted)}
.subject-grid{margin-top:18px;display:flex;flex-wrap:wrap;gap:18px}
.subject-card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:20px;border-radius:14px;width:200px;cursor:pointer;box-shadow:0 10px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.02);font-weight:800;color:var(--light-blue);text-align:center}
.subject-card:hover{transform:translateY(-6px);box-shadow:0 18px 50px rgba(6,10,40,0.8)}
.page{display:none}
.page.active{display:block}
.output-box{background:linear-gradient(180deg,#061022,#081428);padding:18px;border-radius:14px;border:1px solid rgba(255,255,255,0.02);color:var(--white)}
#mindmapContainer{position:relative;background:linear-gradient(180deg,#071427,#02101a);border-radius:14px;padding:20px;min-height:500px;overflow:auto;border:1px solid rgba(255,255,255,0.03)}
.mm-node{position:absolute;padding:12px;border-radius:12px;background:#071f35;border:2px solid rgba(132,210,255,0.2);cursor:grab;color:var(--white);min-width:120px;text-align:center;box-shadow:0 10px 24px rgba(2,6,23,0.6);font-size:12px;font-weight:600}
.mm-node.main{left:50%;top:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,var(--light-blue),var(--light-purple));border-color:rgba(255,255,255,0.4);font-size:14px;font-weight:800}
.mm-node.primary{left:10%;top:20%;background:linear-gradient(135deg,#3cd48b,#2eb67d);border-color:rgba(60,212,139,0.4)}
.mm-node.secondary{right:10%;top:20%;background:linear-gradient(135deg,#ff9f43,#ff8b00);border-color:rgba(255,159,67,0.4)}
.mm-node.tertiary{left:5%;bottom:20%;background:linear-gradient(135deg,#ff6b9d,#ff4d82);border-color:rgba(255,107,157,0.4)}
.mm-node.quaternary{right:5%;bottom:20%;background:linear-gradient(135deg,#a8e6cf,#88d8a3);border-color:rgba(168,230,207,0.4)}
.mm-node:active{cursor:grabbing}
#connectionsSvg{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:1}
.mm-line{stroke:#84d2ff;stroke-width:2;fill:none;opacity:0.6}
#chatBox{background:#061025;padding:12px;border-radius:12px;min-height:360px;max-height:520px;overflow:auto;border:1px solid rgba(255,255,255,0.02)}
.chat-input{margin-top:12px;display:flex;gap:12px}
.chat-input input{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff}
.chat-input button{padding:10px 16px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--light-blue),var(--light-purple));color:#001;font-weight:800}
#homeworkPage textarea{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);background:#061025;color:#fff;resize:vertical}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:26px;padding:10px 18px;border-radius:999px;font-weight:700}
.toast.success{background:var(--success);color:#000}
.toast.error{background:var(--danger);color:#fff}
@media (max-width:900px){#sidebar{display:none}#main{padding:18px}}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage">
  <div class="login-card">
    <h2>STERLA</h2>
    <p>Select your role to continue</p>
    <select id="roleSelect" class="input">
      <option value="">Choose role</option>
      <option value="Student">Student</option>
      <option value="Teacher">Teacher</option>
    </select>
    <button class="btn" onclick="onLogin()">Login</button>
    <p id="loginMessage" style="color:var(--danger);min-height:18px"></p>
    <div style="margin-top:10px;display:flex;gap:8px;justify-content:center">
      <button class="small-btn" onclick="onLogin(true)">Continue as Guest</button>
    </div>
  </div>
</div>

<!-- APP -->
<div id="appPage">
  <aside id="sidebar">
    <div class="brand">STERLA</div>
    <button class="nav-btn active" data-page="homePage" onclick="navigate(event)">Home</button>
    <button class="nav-btn" data-page="subjectsPage" onclick="navigate(event)">Subjects</button>
    <button class="nav-btn" data-page="topicPage" onclick="navigate(event)">Topics</button>
    <button class="nav-btn" data-page="mindmapPage" onclick="navigate(event)">Mind Map</button>
    <button class="nav-btn" data-page="quizPage" onclick="navigate(event)">Quiz</button>
    <button class="nav-btn" data-page="wsPage" onclick="navigate(event)">Worksheet</button>
    <button class="nav-btn" data-page="homeworkPage" onclick="navigate(event)">Homework</button>
    <button class="nav-btn" data-page="aiChatPage" onclick="navigate(event)">AI Chat</button>
    <div style="flex:1"></div>
  </aside>

  <main id="main">
    <section id="homePage" class="page active">
      <div id="welcomeBox">
        <div>
          <h2>Welcome to STERLA</h2>
          <p>Your learning companion — choose a subject and topic to get started.</p>
        </div>
        <div style="text-align:right;color:var(--muted)">
          <div id="welcomeUser">Guest</div>
        </div>
      </div>
      <h3 style="color:var(--light-blue);margin-top:8px">Quick Subjects</h3>
      <div class="subject-grid" id="subjectsQuick"></div>
    </section>

    <section id="subjectsPage" class="page">
      <h3>Subjects</h3>
      <div class="subject-grid" id="subjectsList"></div>
    </section>

    <section id="topicPage" class="page">
      <h3>Topics</h3>
      <div class="subject-grid" id="topicsList"></div>
    </section>

    <section id="mindmapPage" class="page">
      <h3>Mind Map</h3>
      <div style="margin-bottom:20px;display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <select id="mindmapTopicSelect" class="input" style="flex:1;min-width:200px">
          <option value="">Select a topic first</option>
        </select>
        <button class="btn" onclick="generateMindmap()" style="padding:12px 20px">Generate Mindmap</button>
      </div>
      <div id="mindmapContainer">
        <div style="text-align:center;padding:40px;color:var(--muted)">Select a topic and click Generate Mindmap</div>
      </div>
    </section>

    <section id="quizPage" class="page">
      <h3>Quiz</h3>
      <div id="quizOutput" class="output-box"></div>
    </section>

    <section id="wsPage" class="page">
      <h3>Worksheet</h3>
      <div id="wsOutput" class="output-box"></div>
    </section>

    <section id="homeworkPage" class="page">
      <h3>Homework Submitter</h3>
      <div style="background:linear-gradient(180deg,#061022,#081428);padding:24px;border-radius:16px;border:1px solid rgba(255,255,255,0.02);">
        <textarea id="homeworkInput" rows="8" placeholder="Write your homework answers here... (e.g., Worksheet answers, Quiz solutions, etc.)"></textarea>
        <div style="margin-top:16px;display:flex;gap:12px;align-items:center;flex-wrap:wrap">
          <button class="btn" onclick="submitHomework()" style="flex:1;min-width:200px">Submit Homework</button>
          <span style="color:var(--muted)">Saved to local storage</span>
        </div>
        <div id="homeworkMessage" style="margin-top:12px;padding:12px;border-radius:10px;display:none"></div>
        <div id="homeworkHistory" style="margin-top:20px"></div>
      </div>
    </section>

    <section id="aiChatPage" class="page">
      <h3>AI Chat</h3>
      <div id="chatBox"></div>
      <div class="chat-input">
        <input type="text" id="chatInput" placeholder="Ask a question..." />
        <button onclick="sendMessage()">Send</button>
      </div>
    </section>
  </main>
</div>

<script>
// ========== GLOBALS ==========
let userName = null, userRole = null;
let selectedSubject = null, chosenTopic = null;

// ========== SAMPLE BANKS ==========
const subjects = ["Grammar","Formal Letter","Speech","Prose","Algebra","Linear Equations","Mensuration","Reproduction in Animals","Sound","Electricity","1857 Revolt","Resources","Judiciary","Vyakaran","Patra Lekhan","HTML","AI Basics","Shabd Roop","Dhatu Roop","French Grammar","Culture","Networks","Cybersecurity"];

const subjectTopics = {
  "Grammar": ["Grammar"], "Formal Letter":["Formal Letter","Patra Lekhan"], "Speech":["Speech"], "Prose":["Prose"], "Algebra":["Algebra"], "Linear Equations":["Linear Equations"],
  "Mensuration":["Mensuration"], "Reproduction in Animals":["Reproduction in Animals"], "Sound":["Sound"], "Electricity":["Electricity"], "1857 Revolt":["1857 Revolt"], "Resources":["Resources"], "Judiciary":["Judiciary"],
  "Vyakaran":["Vyakaran"], "Patra Lekhan":["Patra Lekhan"], "HTML":["HTML"], "AI Basics":["AI Basics"], "Shabd Roop":["Shabd Roop"], "Dhatu Roop":["Dhatu Roop"], "French Grammar":["French Grammar"], "Culture":["Culture"], "Networks":["Networks"], "Cybersecurity":["Cybersecurity"]
};

// ========== MINDMAP DATA - KEY POINTS FOR EACH TOPIC ==========
const mindmapData = {
  "Grammar": {
    main: "Grammar",
    branches: [
      {title: "Parts of Speech", points: ["Noun", "Verb", "Adjective", "Adverb", "Pronoun"]},
      {title: "Sentence Types", points: ["Declarative", "Interrogative", "Exclamatory", "Imperative"]},
      {title: "Tenses", points: ["Present", "Past", "Future", "Perfect"]},
      {title: "Punctuation", points: ["Comma", "Period", "Question Mark", "Exclamation"]}
    ]
  },
  "Formal Letter": {
    main: "Formal Letter",
    branches: [
      {title: "Structure", points: ["Sender's Address", "Date", "Receiver's Address", "Subject", "Salutation"]},
      {title: "Body", points: ["Introduction", "Main Content", "Conclusion"]},
      {title: "Closing", points: ["Yours sincerely", "Best regards", "Signature"]},
      {title: "Tone", points: ["Formal", "Polite", "Professional"]}
    ]
  },
  "Speech": {
    main: "Speech",
    branches: [
      {title: "Structure", points: ["Opening", "Body", "Conclusion"]},
      {title: "Techniques", points: ["Attention Grabber", "Rhetorical Questions", "Stories"]},
      {title: "Delivery", points: ["Voice Modulation", "Eye Contact", "Gestures"]},
      {title: "Timing", points: ["2-3 minutes", "Practice", "Pace Control"]}
    ]
  },
  "Prose": {
    main: "Prose",
    branches: [
      {title: "Features", points: ["Ordinary Language", "No Meter", "Paragraphs"]},
      {title: "Types", points: ["Fiction", "Non-fiction", "Biography"]},
      {title: "Analysis", points: ["Theme", "Characters", "Setting", "Plot"]},
      {title: "Purpose", points: ["Inform", "Entertain", "Persuade"]}
    ]
  },
  "Algebra": {
    main: "Algebra",
    branches: [
      {title: "Basics", points: ["Variables", "Constants", "Expressions", "Equations"]},
      {title: "Operations", points: ["Simplify", "Factor", "Expand"]},
      {title: "Examples", points: ["x + 5 = 12", "2x² + 3x - 5 = 0"]},
      {title: "Applications", points: ["Word Problems", "Geometry"]}
    ]
  },
  "Linear Equations": {
    main: "Linear Equations",
    branches: [
      {title: "Form", points: ["y = mx + c", "ax + by = c"]},
      {title: "Methods", points: ["Substitution", "Elimination", "Graphing"]},
      {title: "Graph", points: ["Straight Line", "Slope", "Intercept"]},
      {title: "Systems", points: ["One Solution", "No Solution", "Infinite"]}
    ]
  },
  "Mensuration": {
    main: "Mensuration",
    branches: [
      {title: "2D Shapes", points: ["Rectangle: l×b", "Triangle: ½bh", "Circle: πr²"]},
      {title: "3D Shapes", points: ["Cube: a³", "Cylinder: πr²h"]},
      {title: "Perimeter", points: ["Rectangle: 2(l+b)", "Circle: 2πr"]},
      {title: "Units", points: ["cm²", "m²", "litres"]}
    ]
  },
  "Reproduction in Animals": {
    main: "Reproduction",
    branches: [
      {title: "Types", points: ["Sexual", "Asexual"]},
      {title: "Sexual", points: ["Male/Female", "Fertilization", "Embryo"]},
      {title: "Asexual", points: ["Binary Fission", "Budding"]},
      {title: "Human", points: ["Ovaries", "Testes", "Pregnancy"]}
    ]
  },
  "Sound": {
    main: "Sound",
    branches: [
      {title: "Nature", points: ["Vibration", "Waves", "Medium"]},
      {title: "Properties", points: ["Pitch", "Loudness", "Quality"]},
      {title: "Speed", points: ["Air: 340m/s", "Water: 1480m/s"]},
      {title: "Echo", points: ["Reflection", "Minimum Distance"]}
    ]
  },
  "Electricity": {
    main: "Electricity",
    branches: [
      {title: "Basics", points: ["Current (I)", "Voltage (V)", "Resistance (R)"]},
      {title: "Ohm's Law", points: ["V = IR"]},
      {title: "Circuits", points: ["Series", "Parallel"]},
      {title: "Safety", points: ["Fuse", "Earthing"]}
    ]
  },
  "1857 Revolt": {
    main: "1857 Revolt",
    branches: [
      {title: "Causes", points: ["Cartridges", "Annexation", "Doctrine"]},
      {title: "Leaders", points: ["Mangal Pandey", "Rani Laxmibai"]},
      {title: "Events", points: ["Meerut", "Delhi", "Kanpur"]},
      {title: "Results", points: ["End of EIC", "Direct Crown Rule"]}
    ]
  },
  "Resources": {
    main: "Resources",
    branches: [
      {title: "Types", points: ["Renewable", "Non-renewable"]},
      {title: "Renewable", points: ["Solar", "Wind", "Water"]},
      {title: "Non-renewable", points: ["Coal", "Petroleum", "Natural Gas"]},
      {title: "Conservation", points: ["Reduce", "Reuse", "Recycle"]}
    ]
  },
  "Judiciary": {
    main: "Judiciary",
    branches: [
      {title: "Structure", points: ["Supreme Court", "High Court", "District Court"]},
      {title: "Functions", points: ["Interpret Law", "Protect Rights"]},
      {title: "Independence", points: ["Tenure", "Salary", "No Interference"]},
      {title: "PIL", points: ["Public Interest", "Any Citizen"]}
    ]
  },
  "Vyakaran": {
    main: "Vyakaran",
    branches: [
      {title: "Sandhi", points: ["Swar Sandhi", "Vyanjan Sandhi"]},
      {title: "Samas", points: ["Karmadharaya", "Bahuvrihi"]},
      {title: "Karaka", points: ["Karta", "Karma", "Karan"]},
      {title: "Vachan", points: ["Ekatvak", "Bahuvachak"]}
    ]
  },
  "Patra Lekhan": {
    main: "Patra Lekhan",
    branches: [
      {title: "Prakar", points: ["Nivedan Patra", "Shikayat Patra"]},
      {title: "Bhasha", points: ["Saral", "Sanskrit Nishedh"]},
      {title: "Format", points: ["Prakartak", "Patra", "Samapan"]},
      {title: "Udeshya", points: ["Suvidha", "Sahayta"]}
    ]
  },
  "HTML": {
    main: "HTML",
    branches: [
      {title: "Tags", points: ["&lt;p&gt;", "&lt;h1&gt;", "&lt;div&gt;"]},
      {title: "Structure", points: ["&lt;!DOCTYPE&gt;", "&lt;head&gt;", "&lt;body&gt;"]},
      {title: "Elements", points: ["&lt;img&gt;", "&lt;a&gt;", "&lt;ul&gt;"]},
      {title: "Attributes", points: ["src", "href", "class", "id"]}
    ]
  },
  "AI Basics": {
    main: "AI Basics",
    branches: [
      {title: "Types", points: ["Narrow AI", "General AI", "Super AI"]},
      {title: "Techniques", points: ["Machine Learning", "Deep Learning"]},
      {title: "Applications", points: ["Chatbots", "Image Recognition"]},
      {title: "Ethics", points: ["Privacy", "Bias", "Jobs"]}
    ]
  },
  "Shabd Roop": {
    main: "Shabd Roop",
    branches: [
      {title: "Vibhakti", points: ["Pratham", "Dwitaya", "Tritya"]},
      {title: "Vachan", points: ["Eka", "Dwi", "Bahu"]},
      {title: "Ling", points: ["Pumling", "Stri ling"]},
      {title: "Karak", points: ["Karta", "Karma"]}
    ]
  },
  "Dhatu Roop": {
    main: "Dhatu Roop",
    branches: [
      {title: "Kaal", points: ["Vartaman", "Bhuta", "Bhavishya"]},
      {title: "Purush", points: ["Uttam", "Madhyam", "Anya"]},
      {title: "Vachan", points: ["Eka", "Dwi", "Bahu"]},
      {title: "Prayog", points: ["Kartari", "Karmakartari"]}
    ]
  },
  "French Grammar": {
    main: "French Grammar",
    branches: [
      {title: "Articles", points: ["Le", "La", "Les", "Un", "Une"]},
      {title: "Verbs", points: ["Etre", "Avoir", "Parler"]},
      {title: "Tenses", points: ["Present", "Passe Compose"]},
      {title: "Gender", points: ["Masculin", "Feminine"]}
    ]
  },
  "Culture": {
    main: "French Culture",
    branches: [
      {title: "Food", points: ["Croissant", "Escargot", "Wine"]},
      {title: "Festivals", points: ["Bastille Day", "Christmas"]},
      {title: "Art", points: ["Louvre", "Monet", "Eiffel Tower"]},
      {title: "Etiquette", points: ["Bonjour", "Kiss Greeting"]}
    ]
  },
  "Networks": {
    main: "Networks",
    branches: [
      {title: "Types", points: ["LAN", "WAN", "MAN"]},
      {title: "Devices", points: ["Router", "Switch", "Modem"]},
      {title: "Topology", points: ["Star", "Bus", "Ring"]},
      {title: "Protocols", points: ["TCP/IP", "HTTP"]}
    ]
  },
  "Cybersecurity": {
    main: "Cybersecurity",
    branches: [
      {title: "Threats", points: ["Virus", "Phishing", "Malware"]},
      {title: "Protection", points: ["Firewall", "Antivirus", "Encryption"]},
      {title: "Practices", points: ["Strong Password", "2FA"]},
      {title: "Laws", points: ["Data Protection", "Cyber Crime"]}
    ]
  }
};

// Quiz and worksheet banks (unchanged)
const quizBank = {
  "Grammar":[
    { q:"Which of the following is a noun?", options:["run","dog","quickly","beautiful"], answer:"dog" },
    { q:"Identify the verb in the sentence.", options:["is","happy","table","red"], answer:"is" },
    { q:"What is an adjective?", options:["A describing word","A doing word","A place","A person"], answer:"A describing word" }
  ],
  // ... (keeping existing quizBank data as is for brevity)
};

const wsBank = {
  "Grammar":["1. Write 5 nouns.","2. Write 5 verbs.","3. Identify parts of speech.","4. Form 5 adverbs.","5. Write 3 complex sentences."],
  // ... (keeping existing wsBank data as is for brevity)
};

const aiBank = {
  "Grammar":[{q:"noun",a:"A noun is a person, place, thing, or idea."}],
  // ... (keeping existing aiBank data as is for brevity)
};

// ========== LOGIN ==========
function onLogin(guest=false){
  const msg = document.getElementById('loginMessage');
  msg.textContent='';
  if(!guest){
    const role=document.getElementById('roleSelect').value;
    if(!role){ msg.textContent='Select Student or Teacher'; return; }
    userName=role+" User"; userRole=role;
  } else { userName='Guest'; userRole='Guest'; }
  document.getElementById('loginPage').style.display='none';
  document.getElementById('appPage').style.display='flex';
  document.getElementById('welcomeUser').innerText=userName;
  loadSubjects();
}

// ========== NAVIGATION ==========
function navigate(e){
  document.querySelectorAll('#sidebar .nav-btn').forEach(b=>b.classList.remove('active'));
  e.currentTarget.classList.add('active');
  const page=e.currentTarget.dataset.page;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(page).classList.add('active');
  if(page==='subjectsPage') loadSubjects();
  if(page==='topicPage') renderTopics();
  if(page==='mindmapPage') loadMindmapTopics();
  if(page==='quizPage') loadQuiz();
  if(page==='wsPage') loadWorksheet();
  if(page==='homeworkPage') loadHomeworkHistory();
}

// ========== SUBJECTS ==========
function loadSubjects(){
  const quick=document.getElementById('subjectsQuick');
  const list=document.getElementById('subjectsList');
  quick.innerHTML=''; list.innerHTML='';
  subjects.forEach(sub=>{
    const btnQuick=document.createElement('button');
    btnQuick.className='subject-card'; btnQuick.innerText=sub;
    btnQuick.onclick=()=>selectSubject(sub); quick.appendChild(btnQuick);
    const btnList=document.createElement('button');
    btnList.className='subject-card'; btnList.innerText=sub;
    btnList.onclick=()=>selectSubject(sub); list.appendChild(btnList);
  });
}
function selectSubject(sub){
  selectedSubject=sub; chosenTopic=subjectTopics[sub][0];
  navigate({currentTarget:{dataset:{page:'topicPage'}}, preventDefault:()=>{}});
}

// ========== TOPICS ==========
function renderTopics(){
  const container=document.getElementById('topicsList'); container.innerHTML='';
  if(!selectedSubject) return;
  subjectTopics[selectedSubject].forEach(t=>{
    const btn=document.createElement('button'); btn.className='subject-card'; btn.innerText=t;
    btn.onclick=()=>{ chosenTopic=t; loadQuiz(); loadWorksheet(); };
    container.appendChild(btn);
  });
}

// ========== MINDMAP ==========
function loadMindmapTopics(){
  const select = document.getElementById('mindmapTopicSelect');
  select.innerHTML = '<option value="">Select a topic</option>';
  Object.keys(mindmapData).forEach(topic => {
    const option = document.createElement('option');
    option.value = topic;
    option.text = topic;
    select.appendChild(option);
  });
}

function generateMindmap(){
  const topic = document.getElementById('mindmapTopicSelect').value;
  const container = document.getElementById('mindmapContainer');
  
  if(!topic || !mindmapData[topic]){
    showToast('Please select a valid topic', 'error');
    return;
  }
  
  container.innerHTML = `
    <svg id="connectionsSvg" width="100%" height="100%"></svg>
    <div style="position:relative;height:100%;width:100%"></div>
  `;
  
  const data = mindmapData[topic];
  const nodesContainer = container.querySelector('div');
  
  // Create main node
  const mainNode = document.createElement('div');
  mainNode.className = 'mm-node main';
  mainNode.innerText = data.main;
  nodesContainer.appendChild(mainNode);
  
  // Create branch nodes
  data.branches.forEach((branch, index) => {
    const branchNode = document.createElement('div');
    branchNode.className = `mm-node ${['primary','secondary','tertiary','quaternary'][index % 4]}`;
    branchNode.innerHTML = `<strong>${branch.title}</strong><br>${branch.points.slice(0,3).join('<br>')}`;
    nodesContainer.appendChild(branchNode);
    
    // Draw connection line
    setTimeout(() => drawLine(mainNode, branchNode), 100);
  });
  
  showToast(`Mindmap generated for ${topic}!`, 'success');
}

function drawLine(fromNode, toNode){
  const svg = document.getElementById('connectionsSvg');
  const rect1 = fromNode.getBoundingClientRect();
  const rect2 = toNode.getBoundingClientRect();
  const containerRect = svg.getBoundingClientRect();
  
  const x1 = rect1.left + rect1.width/2 - containerRect.left;
  const y1 = rect1.top + rect1.height/2 - containerRect.top;
  const x2 = rect2.left + rect2.width/2 - containerRect.left;
  const y2 = rect2.top + rect2.height/2 - containerRect.top;
  
  const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  line.setAttribute('d', `M ${x1},${y1} Q ${(x1+x2)/2},${y1+50} ${x2},${y2}`);
  line.className = 'mm-line';
  svg.appendChild(line);
}

// ========== QUIZ (unchanged) ==========
function loadQuiz(){
  const out=document.getElementById('quizOutput'); out.innerHTML='';
  if(!chosenTopic || !quizBank[chosenTopic]) { out.innerHTML='No quiz available'; return; }
  quizBank[chosenTopic].forEach((qObj,idx)=>{
    const div=document.createElement('div'); div.style.marginBottom='10px';
    const p=document.createElement('p'); p.innerText=(idx+1)+". "+qObj.q; div.appendChild(p);
    qObj.options.forEach(opt=>{
      const btn=document.createElement('button'); btn.innerText=opt; btn.style.marginRight='8px';
      btn.onclick=()=>checkAnswer(idx,opt); div.appendChild(btn);
    });
    out.appendChild(div);
  });
}
function checkAnswer(idx,opt){
  const correct=quizBank[chosenTopic][idx].answer;
  showToast(opt===correct?'✅ Correct':'❌ Wrong');
}

// ========== WORKSHEET (unchanged) ==========
function loadWorksheet(){
  const out=document.getElementById('wsOutput'); out.innerHTML='';
  if(!chosenTopic || !wsBank[chosenTopic]) { out.innerHTML='No worksheet'; return; }
  out.innerHTML='<ol>'+wsBank[chosenTopic].map(i=>`<li>${i}</li>`).join('')+'</ol>';
}

// ========== HOMEWORK ==========
function submitHomework(){
  const input = document.getElementById('homeworkInput');
  const msg = document.getElementById('homeworkMessage');
  const text = input.value.trim();
  
  if(!text){
    msg.textContent = 'Please enter your homework before submitting.';
    msg.style.background = 'rgba(229, 90, 90, 0.2)';
    msg.style.color = '#e55a5a';
    msg.style.display = 'block';
    return;
  }
  
  const homework = {
    id: Date.now(),
    topic: chosenTopic || 'General',
    content: text,
    timestamp: new Date().toLocaleString(),
    user: userName
  };
  
  let history = JSON.parse(localStorage.getItem('sterlaHomework') || '[]');
  history.unshift(homework);
  localStorage.setItem('sterlaHomework', JSON.stringify(history.slice(0,10))); // Keep last 10
  
  input.value = '';
  msg.textContent = `Homework for "${homework.topic}" submitted successfully!`;
  msg.style.background = 'rgba(60, 212, 139, 0.2)';
  msg.style.color = '#3cd48b';
  msg.style.display = 'block';
  
  setTimeout(() => {
    msg.style.display = 'none';
    loadHomeworkHistory();
  }, 3000);
}

function loadHomeworkHistory(){
  const history = JSON.parse(localStorage.getItem('sterlaHomework') || '[]');
  const container = document.getElementById('homeworkHistory');
  
  if(history.length === 0){
    container.innerHTML = '<div style="color:var(--muted);padding:20px;text-align:center">No homework submissions yet</div>';
    return;
  }
  
  container.innerHTML = `
    <h4 style="color:var(--light-blue);margin-bottom:16px">Recent Submissions (${history.length})</h4>
    <div style="max-height:300px;overflow:auto">
      ${history.map(h => `
        <div style="background:rgba(255,255,255,0.03);padding:12px;margin-bottom:8px;border-radius:8px;border-left:3px solid var(--light-blue)">
          <div style="font-weight:600;color:var(--light-purple)">${h.topic}</div>
          <div style="color:var(--muted);font-size:12px">${h.timestamp}</div>
          <div style="margin-top:8px;font-size:13px">${h.content.substring(0,100)}${h.content.length > 100 ? '...' : ''}</div>
        </div>
      `).join('')}
    </div>
  `;
}

// ========== AI CHAT (unchanged) ==========
function sendMessage(){
  const input=document.getElementById('chatInput'); let msg=input.value.trim(); if(!msg) return; input.value='';
  const chatBox=document.getElementById('chatBox'); chatBox.innerHTML+=`<div><b>You:</b> ${msg}</div>`;
  let reply='Sorry, I do not know.';
  if(chosenTopic && aiBank[chosenTopic]){
    const match=aiBank[chosenTopic].find(o=>msg.toLowerCase().includes(o.q.toLowerCase()));
    reply=match?match.a:aiBank[chosenTopic][0].a;
  }
  chatBox.innerHTML+=`<div><b>AI:</b> ${reply}</div>`; chatBox.scrollTop=chatBox.scrollHeight;
}

// ========== UTILITIES ==========
function showToast(msg,type='success'){
  const t=document.createElement('div'); t.className='toast '+(type==='success'?'success':'error'); t.innerText=msg;
  document.body.appendChild(t); setTimeout(()=>t.remove(),2000);
}
</script>
</body>
</html>
